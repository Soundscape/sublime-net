(function(){var n,e,r,t,i,s,o,c=function(n,e){function r(){this.constructor=n}for(var t in e)u.call(e,t)&&(n[t]=e[t]);return r.prototype=e.prototype,n.prototype=new r,n.__super__=e.prototype,n},u={}.hasOwnProperty;e=require("sublime-core"),s=require("autobahn"),t=require("when"),i=require("lodash"),r=require("sublime-error"),r.mixins.value(),o={disconnected:{connect:function(n,e){n.connection.onopen=function(r){return function(t,i){n.session=t,r.setMachineState(r.connected),e.resolve(n)}}(this),n.connection.open()}},connected:{disconnect:function(n,e){n.connection.onclose=function(r){return function(t,i){n.session=null,r.setMachineState(r.disconnected),e.resolve(n)}}(this),n.connection.close()},subscribe:function(n,e,r,t){n.session.subscribe(e,r).then(function(i){var s;s={subscription:i,fn:r},n.channels[e]=n.channels[e]||[],n.channels[e].push(s),t.resolve(n)},function(n){t.reject(n)})},unsubscribe:function(n,e,r,i){var s;n.channels[e]&&(s=n.channels[e].filter(function(n){return n.fn===r}).map(function(e){return n.session.unsubscribe(e.subscription)}),t.all(s).then(function(){n.channels[e]=n.channels[e].filter(function(n){return n.fn!==r}),0===n.channels[e].length&&(n.channels[e]=null),i.resolve(n)},function(n){i.reject(n)}))},publish:function(n,e,r,t,s){t=i.extend({acknowledge:!0,exclude_me:!0},t),Array.isArray(r)||(r=[r]),n.session.publish(e,r,{},t).then(function(){s.resolve(n)},function(n){s.reject(n)})},register:function(n,e,r,t,i){n.session.register(e,r,t).then(function(){i.resolve(n)},function(n){i.reject(n)})},unregister:function(n,e,r){var i;i=n.session.registrations.filter(function(n){return n.procedure===e}).map(function(e){return n.session.unregister(e)}),t.all(i).then(function(){r.resolve(n)},function(n){r.reject(n)})},call:function(n,e,r,t,i){Array.isArray(r)||(r=[r]),n.session.call(e,r,{},t).then(function(n){i.resolve(n)},function(n){i.reject(n)})}}},n=function(n){function e(n,t){r.Throw.isUnspecified(n,"WAMP URI"),r.Throw.isUnspecified(t,"WAMP realm"),e.__super__.constructor.call(this,o),this.channels={},this.uri=n,this.realm=t,this.connection=new s.Connection({url:n,realm:t})}return c(e,n),e.prototype.connect=function(){var n;return n=t.defer(),this.apply("connect",this,n),n.promise},e.prototype.disconnect=function(){var n;return n=t.defer(),this.apply("disconnect",this,n),n.promise},e.prototype.subscribe=function(n,e){var i;return r.Throw.isUnspecified(n,"channel"),i=t.defer(),this.apply("subscribe",this,n,e,i),i.promise},e.prototype.unsubscribe=function(n,e){var i;return r.Throw.isUnspecified(n,"channel"),i=t.defer(),this.apply("unsubscribe",this,n,e,i),i.promise},e.prototype.publish=function(n,e,i){var s;return r.Throw.isUnspecified(n,"channel"),r.Throw.isNullOrUndefined(e,"message payload"),s=t.defer(),this.apply("publish",this,n,e,i,s),s.promise},e.prototype.register=function(n,e,i){var s;return r.Throw.isUnspecified(n,"channel"),r.Throw.isNullOrUndefined(e,"remote function"),s=t.defer(),this.apply("register",this,n,e,i,s),s.promise},e.prototype.unregister=function(n){var e;return r.Throw.isUnspecified(n,"channel"),e=t.defer(),this.apply("unregister",this,n,e),e.promise},e.prototype.call=function(n,e,i){var s;return r.Throw.isUnspecified(n,"channel"),s=t.defer(),this.apply("call",this,n,e,i,s),s.promise},e}(e.Stateful),module.exports=n}).call(this);
