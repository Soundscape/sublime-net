(function(){var n,e,t,r,i,o,s=function(n,e){function t(){this.constructor=n}for(var r in e)c.call(e,r)&&(n[r]=e[r]);return t.prototype=e.prototype,n.prototype=new t,n.__super__=e.prototype,n},c={}.hasOwnProperty;e=require("sublime-core"),i=require("autobahn"),t=require("when"),r=require("lodash"),o={disconnected:{connect:function(n,e){n.connection.onopen=function(t){return function(r,i){n.session=r,t.setMachineState(t.connected),e.resolve(n)}}(this),n.connection.open()}},connected:{disconnect:function(n,e){n.connection.onclose=function(t){return function(r,i){n.session=null,t.setMachineState(t.disconnected),e.resolve(n)}}(this),n.connection.close()},subscribe:function(n,e,t,r){n.session.subscribe(e,t).then(function(i){var o;o={subscription:i,fn:t},n.channels[e]=n.channels[e]||[],n.channels[e].push(o),r.resolve(n)},function(n){r.reject(n)})},unsubscribe:function(n,e,r,i){var o;n.channels[e]&&(o=n.channels[e].filter(function(n){return n.fn===r}).map(function(e){return n.session.unsubscribe(e.subscription)}),t.all(o).then(function(){n.channels[e]=n.channels[e].filter(function(n){return n.fn!==r}),0===n.channels[e].length&&(n.channels[e]=null),i.resolve(n)},function(n){i.reject(n)}))},publish:function(n,e,t,i,o){i=r.extend({acknowledge:!0,exclude_me:!0},i),Array.isArray(t)||(t=[t]),n.session.publish(e,t,{},i).then(function(){o.resolve(n)},function(n){o.reject(n)})},register:function(n,e,t,r,i){n.session.register(e,t,r).then(function(){i.resolve(n)},function(n){i.reject(n)})},unregister:function(n,e,r){var i;i=n.session.registrations.filter(function(n){return n.procedure===e}).map(function(e){return n.session.unregister(e)}),t.all(i).then(function(){r.resolve(n)},function(n){r.reject(n)})},call:function(n,e,t,r,i){Array.isArray(t)||(t=[t]),n.session.call(e,t,{},r).then(function(n){i.resolve(n)},function(n){i.reject(n)})}}},n=function(n){function e(n,t){e.__super__.constructor.call(this,o),this.channels={},this.uri=n,this.realm=t,this.connection=new i.Connection({url:n,realm:t})}return s(e,n),e.prototype.connect=function(){var n;return n=t.defer(),this.apply("connect",this,n),n.promise},e.prototype.disconnect=function(){var n;return n=t.defer(),this.apply("disconnect",this,n),n.promise},e.prototype.subscribe=function(n,e){var r;return r=t.defer(),this.apply("subscribe",this,n,e,r),r.promise},e.prototype.unsubscribe=function(n,e){var r;return r=t.defer(),this.apply("unsubscribe",this,n,e,r),r.promise},e.prototype.publish=function(n,e,r){var i;return i=t.defer(),this.apply("publish",this,n,e,r,i),i.promise},e.prototype.register=function(n,e,r){var i;return i=t.defer(),this.apply("register",this,n,e,r,i),i.promise},e.prototype.unregister=function(n){var e;return e=t.defer(),this.apply("unregister",this,n,e),e.promise},e.prototype.call=function(n,e,r){var i;return i=t.defer(),this.apply("call",this,n,e,r,i),i.promise},e}(e.Stateful),module.exports=n}).call(this);
